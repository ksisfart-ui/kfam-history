<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暦ちひろDM履歴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background-color: white; }
        .header { background-color: #335c7d; color: white; padding: 14px 16px; font-weight: bold; font-size: 1.1rem; }
        .hidden { display: none !important; }

        /* リストアイテムの修正 */
        .list-item {
            display: flex;
            flex-direction: row; /* 横並びを強制 */
            justify-content: space-between;
            align-items: center;
            padding: 18px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .list-item:active { background-color: #f0f4f8; }

        /* チャット表示の調整 */
        .bubble {
            background-color: #f1f3f5; border-radius: 18px; padding: 10px 16px;
            display: inline-block; max-width: 85%; line-height: 1.5; color: #333;
        }
        .user-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .icon-placeholder { background-color: #e9ecef; display: flex; align-items: center; justify-content: center; text-size: 10px; color: #999; }

        /* 連続メッセージ用 */
        .consecutive-msg { margin-top: -12px !important; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">暦ちひろDM履歴</div>

    <div id="home-screen">
        <div class="p-4 font-bold text-gray-500 text-sm bg-gray-50 border-b">メッセージ</div>
        <div id="group-list"></div>
    </div>

    <div id="chat-screen" class="hidden">
        <div class="p-2 border-b flex items-center bg-white sticky top-0 z-20">
            <button onclick="showHome()" class="flex items-center text-[#007AFF] px-2 py-1">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                <span class="text-[17px] ml-1">戻る</span>
            </button>
            <span id="chat-title" class="ml-4 font-bold text-gray-800 text-[17px]"></span>
        </div>
        <div id="chat-content" class="p-4 space-y-5 min-h-screen"></div>
    </div>
</div>

<script>
    let allChatData = {};

    async function loadData() {
        try {
            const response = await fetch(`data.json?v=${Date.now()}`);
            allChatData = await response.json();
            renderGroupList();
        } catch (e) { console.error("Load error", e); }
    }

    function renderGroupList() {
        const list = document.getElementById('group-list');
        list.innerHTML = '';
        Object.keys(allChatData).forEach(name => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.onclick = () => showChat(name);
            item.innerHTML = `
                <span class="text-[17px] text-gray-800 font-medium">${name}</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            `;
            list.appendChild(item);
        });
    }

    function showChat(groupName) {
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('chat-screen').classList.remove('hidden');
        document.getElementById('chat-title').innerText = groupName;

        const container = document.getElementById('chat-content');
        container.innerHTML = '';

        const messages = allChatData[groupName] || [];
        let lastSender = null;
        let lastDate = null;

        messages.forEach(msg => {
            const isConsecutive = (msg.name === lastSender && msg.date === lastDate);
            const row = document.createElement('div');
            row.className = `flex items-start space-x-3 ${isConsecutive ? 'consecutive-msg' : ''}`;

            // アイコン判定ロジック
            let iconHtml = '';
            if (!isConsecutive) {
                if (msg.icon) {
                    iconHtml = `<img src="${msg.icon}" class="user-icon">`;
                } else if (msg.name === "ちひろ") {
                    iconHtml = `<div class="user-icon icon-placeholder text-[10px]">No Img</div>`;
                } else {
                    iconHtml = `<div class="user-icon ${msg.color || 'bg-gray-300'}"></div>`;
                }
            } else {
                // 連続メッセージの場合はアイコン分のスペースだけ空ける
                iconHtml = `<div class="w-10 flex-shrink-0"></div>`;
            }

            row.innerHTML = `
                ${iconHtml}
                <div class="flex-1">
                    ${!isConsecutive ? `<div class="text-[11px] text-gray-400 mb-1 ml-1">${msg.name} ・ ${msg.date}</div>` : ''}
                    <div class="bubble text-[15px]">${msg.text}</div>
                </div>
            `;
            container.appendChild(row);

            lastSender = msg.name;
            lastDate = msg.date;
        });
        window.scrollTo(0, 0);
    }

    function showHome() {
        document.getElementById('home-screen').classList.remove('hidden');
        document.getElementById('chat-screen').classList.add('hidden');
    }

    loadData();
</script>
</body>
</html>
